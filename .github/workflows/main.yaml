name: Terraform CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  terraform:
    name: Terraform Plan
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      - name: Terraform Init (AzureRM Backend)
        env:
          # üîê AzureRM Provider Auth (Service Principal)
          ARM_CLIENT_ID:       ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET:   ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID:       ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

          # üóÉÔ∏è Backend Config (azurerm backend)
          ARM_STORAGE_ACCOUNT: ${{ secrets.BACKEND_STORAGE_ACCOUNT }}
          ARM_CONTAINER_NAME:  ${{ secrets.BACKEND_CONTAINER_NAME }}
          ARM_KEY:             ${{ secrets.BACKEND_KEY }}
        run: |
          az login --service-principal -u ${ARM_CLIENT_ID} -p ${ARM_CLIENT_SECRET} --tenant ${ARM_TENANT_ID}
          az account set --subscription ${ARM_SUBSCRIPTION_ID}
          # Fail fast on missing secrets
          set -euo pipefail
          for var in ARM_CLIENT_ID ARM_CLIENT_SECRET ARM_TENANT_ID ARM_SUBSCRIPTION_ID \
                     ARM_STORAGE_ACCOUNT ARM_CONTAINER_NAME ARM_KEY; do
            if [ -z "${!var}" ]; then
              echo "::error::Missing required secret: $var"
              exit 1
            fi
          done

          echo "‚úÖ Initializing Terraform with AzureRM backend..."

          terraform init \
            -backend-config="storage_account_name=${ARM_STORAGE_ACCOUNT}" \
            -backend-config="container_name=${ARM_CONTAINER_NAME}" \
            -backend-config="key=${ARM_KEY}" \
            -input=false \
            -no-color

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        run: |
          terraform plan \
            -input=false \
            -no-color \
            -out=tfplan